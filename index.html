<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premium Expense Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #0b1020;                       /* page background */
      --bg-accent: radial-gradient(1200px 600px at 20% -10%, rgba(59,130,246,.12), transparent 60%),
                   radial-gradient(900px 500px at 110% 10%, rgba(168,85,247,.10), transparent 60%),
                   linear-gradient(180deg, #0b1020 0%, #0d1326 60%, #0b1020 100%);
      --surface: rgba(17, 24, 39, .55);    /* glass card */
      --surface-2: rgba(31, 41, 55, .6);
      --text: #f9fafb;                     /* primary text */
      --muted: #a2adc2;                    /* secondary text */
      --border: rgba(255,255,255,.10);
      --primary: #60a5fa;                  /* blue */
      --primary-strong: #3b82f6;
      --accent: #a78bfa;                   /* violet */
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --blur: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; }

    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: var(--bg-accent);
      background-color: var(--bg);
      padding: 2rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    /* ---------- Header ---------- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    header h1 {
      font-weight: 800;
      font-size: clamp(1.4rem, 2.2vw, 2rem);
      letter-spacing: 0.2px;
      line-height: 1.1;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-right { display: flex; align-items: center; gap: .75rem; }
    #clock { color: var(--muted); font-weight: 600; font-size: .95rem; }
    #logout-btn { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* ---------- Cards / Glass ---------- */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)) , var(--surface);
      backdrop-filter: saturate(1.2) blur(var(--blur));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.25rem 1.35rem;
      position: relative;
      overflow: hidden;
    }
    .card::after { /* subtle gradient edge */
      content: "";
      position: absolute; inset: -1px;
      border-radius: inherit;
      pointer-events: none;
      background: linear-gradient(120deg, rgba(96,165,250,.25), rgba(167,139,250,.18) 40%, transparent 70%);
      mask: linear-gradient(black, black) content-box, linear-gradient(black, black);
      -webkit-mask-composite: xor; mask-composite: exclude;
      padding: 1px; 
    }

    /* ---------- Summary cards ---------- */
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25rem; }
    .summary-card { display: grid; gap: .4rem; align-content: start; }
    .summary-card .icon { font-size: 1.5rem; }
    .summary-card .title { color: var(--muted); font-weight: 600; font-size: .85rem; }
    .summary-card .value { font-size: clamp(1.4rem, 2.4vw, 1.9rem); font-weight: 800; }

    /* ---------- Main grid ---------- */
    .main-content { display: grid; grid-template-columns: 360px 1fr; gap: 1.25rem; align-items: start; }

    h2 { font-size: 1.15rem; font-weight: 700; letter-spacing: .2px; margin-bottom: 1rem; }

    /* ---------- Form ---------- */
    .form-container form { display: grid; gap: .9rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: .9rem; }

    .form-group { display: grid; gap: .45rem; }
    .form-group label { color: var(--muted); font-weight: 600; font-size: .85rem; }
    input, select, button {
      font: inherit; font-weight: 600;
      padding: .8rem .9rem; border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(30, 41, 59, .55);
      color: var(--text);
      transition: border-color .2s ease, box-shadow .2s ease, transform .08s ease;
    }
    input::placeholder { color: #96a0b8; opacity: .9; font-weight: 500; }
    input:focus, select:focus {
      outline: none; border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,.22);
    }
    button { background: linear-gradient(135deg, var(--primary-strong), var(--accent)); color: white; border: none; }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); filter: brightness(.98); }

    #back-btn { background: transparent; color: var(--text); border: 1px solid var(--border); padding: .5rem .7rem; }
    #back-btn.hidden { display: none; }

    /* ---------- Controls ---------- */
    .controls-header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .header-title { display: flex; align-items: center; gap: .75rem; min-width: 0; }
    #history-title { margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .controls { display: flex; gap: .6rem; flex-wrap: wrap; }
    .controls input, .controls select { background: rgba(17,24,39,.55); }

    #sort-order-btn { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    #sort-order-btn:hover { background: rgba(255,255,255,.04); color: var(--text); }

    /* ---------- Table ---------- */
    .table-wrapper { overflow-x: auto; }
    .transaction-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .transaction-table thead th { font-size: .78rem; text-transform: uppercase; letter-spacing: .04em; color: var(--muted); font-weight: 700; padding: .9rem 1rem; background: transparent; position: sticky; top: 0; backdrop-filter: blur(8px); }
    .transaction-table tbody tr { transition: background-color .15s ease, transform .08s ease; }
    .transaction-table td { padding: 1rem; border-top: 1px solid var(--border); }
    .transaction-table tbody tr:nth-child(odd) { background: rgba(255,255,255,.02); }
    .transaction-table tbody tr:hover { background: rgba(96,165,250,.12); }

    .clickable-name { cursor: pointer; font-weight: 700; color: #c3d9ff; }
    .clickable-name:hover { color: #e2ecff; text-decoration: underline; }

    .transaction-table .empty-row td { text-align: center; padding: 2.5rem 1rem; color: var(--muted); }

    /* ---------- Animations ---------- */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .new-row { animation: fadeInUp .4s ease both; }

    /* ---------- Auth ---------- */
    #auth-container { min-height: 100vh; display: grid; place-items: center; text-align: left; }
    #auth-card { width: 100%; max-width: 420px; }
    #auth-card h2 { margin-bottom: .75rem; }
    #auth-notice { color: var(--muted); font-size: .8rem; }

    .divider { display: flex; align-items: center; gap: .75rem; color: var(--muted); margin: 1rem 0; }
    .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: var(--border); }

    #google-signin-btn { background: rgba(255,255,255,.05); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; gap: .65rem; }
    #google-signin-btn:hover { background: rgba(255,255,255,.08); }

    /* ---------- Watermark ---------- */
    #watermark { position: fixed; bottom: .8rem; right: .9rem; color: rgba(255,255,255,.18); font-size: .75rem; letter-spacing: .08em; pointer-events: none; z-index: 1000; }

    /* ---------- Responsive ---------- */
    @media (max-width: 980px) { .main-content { grid-template-columns: 1fr; } }

    @media (max-width: 720px) {
      body { padding: 1.25rem; }
      .summary-cards { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
      .form-row { grid-template-columns: 1fr; }
      .transaction-table thead th { font-size: .72rem; }
    }

    /* Stacked card view for very small phones */
    @media (max-width: 440px) {
      .controls { flex-direction: column; width: 100%; }
      .transaction-table, .transaction-table thead, .transaction-table tbody, .transaction-table th, .transaction-table td, .transaction-table tr { display: block; width: 100%; }
      .transaction-table thead { display: none; }
      .transaction-table tbody tr { background: var(--surface-2); border: 1px solid var(--border); border-radius: 14px; padding: .75rem .9rem; margin-bottom: .9rem; }
      .transaction-table td { display: flex; justify-content: space-between; align-items: center; border: none; padding: .5rem 0; }
      .transaction-table td::before { content: attr(data-label); color: var(--muted); font-weight: 700; margin-right: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Auth -->
  <div id="auth-container">
    <div id="auth-card" class="card">
      <h2 id="auth-title">Log in to your Dashboard</h2>
      <form id="auth-form">
        <div class="form-group">
          <label for="auth-email">Email</label>
          <input type="email" id="auth-email" placeholder="you@example.com" required />
        </div>
        <div class="form-group">
          <label for="auth-password">Password</label>
          <input type="password" id="auth-password" placeholder="••••••••" minlength="6" required />
        </div>
        <button type="submit" id="auth-submit-btn">Log In</button>
      </form>
      <div id="auth-error" style="color:#fca5a5; text-align:center; margin:.75rem 0 .25rem;"></div>
      <div class="divider">or</div>
      <button id="google-signin-btn" type="button" aria-label="Sign in with Google">
        <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20" height="20" aria-hidden="true">
          <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/>
          <path fill="#FF3D00" d="M6.306 14.691L4 17.696C4.681 19.045 5.541 20.301 6.471 21.492c1.236 1.543 2.658 2.872 4.09 4.108l2.67-2.67c-1.391-1.161-2.483-2.585-3.328-4.108z"/>
          <path fill="#4CAF50" d="M14.001 20l1.55 1.496l1.248 1.53l3.078 3.076l-1.666 1.666c-.663.664-1.442 1.233-2.316 1.76l-2.072-2.071c-.754-.753-1.636-1.378-2.613-1.879l-1.55 1.496c-.461 1.455-.733 2.993-.733 4.582c0 3.018.98 5.867 2.709 8.16l2.164-2.165c-1.375-1.921-2.203-4.223-2.203-6.687c0-1.842.368-3.59.988-5.186z"/>
          <path fill="#1976D2" d="M4.092 14.69l2.215-2.215l1.624 1.564c-.672.673-1.258 1.43-1.764 2.25l-2.075-2.075z"/>
        </svg>
        Sign in with Google
      </button>
      <p style="margin-top: 1rem; color: var(--muted); font-size: .85rem;">
        <span id="auth-link-text">Don't have an account?</span>
        <button id="auth-link" type="button" style="color: #c3d9ff; text-decoration: underline; background: none; border: none; padding: 0; font-size: .85rem;">Sign Up</button>
      </p>
      <p id="auth-notice">Your data is stored privately in a secure Firestore database.</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard-container" class="container" style="display:none;">
    <header>
      <h1>Expense Dashboard</h1>
      <div class="header-right">
        <div id="clock"></div>
        <button id="logout-btn">Log out</button>
      </div>
    </header>

    <section class="summary-cards">
      <div class="card summary-card">
        <div class="icon">💰</div>
        <div class="title">Total Spending</div>
        <div class="value" id="total-spend">₹0.00</div>
      </div>
      <div class="card summary-card">
        <div class="icon">📊</div>
        <div class="title">Total Transactions</div>
        <div class="value" id="total-transactions">0</div>
      </div>
      <div class="card summary-card">
        <div class="icon">⚖️</div>
        <div class="title">Average Transaction</div>
        <div class="value" id="avg-transaction">₹0.00</div>
      </div>
    </section>

    <main class="main-content">
      <!-- Add form -->
      <section id="form-card" class="card form-container">
        <h2>Add Transaction</h2>
        <form id="add-form" autocomplete="off">
          <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" placeholder="e.g., Dinner with friends" required />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="amount">Amount (₹)</label>
              <input type="number" id="amount" placeholder="e.g., 1500" min="0" step="0.01" required />
            </div>
            <div class="form-group">
              <label for="type">Transaction Type</label>
              <select id="type">
                <option value="GPay">GPay</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" required />
          </div>
          <button type="submit">Add Transaction</button>
        </form>
      </section>

      <!-- History -->
      <section id="history-card" class="card">
        <div class="controls-header">
          <div class="header-title">
            <button id="back-btn" class="hidden" type="button">← Back</button>
            <h2 id="history-title">History</h2>
          </div>
          <div class="controls">
            <select id="filter-by">
              <option value="name">Filter by Name</option>
              <option value="amount">Filter by Amount</option>
              <option value="type">Filter by Type</option>
              <option value="date">Filter by Date</option>
            </select>
            <input type="text" id="filter-name" placeholder="Search by name..." />
            <select id="sort-by">
              <option value="date">Sort by Date</option>
              <option value="amount">Sort by Amount</option>
              <option value="name">Sort by Name</option>
            </select>
            <button id="sort-order-btn" type="button">Desc ⬇️</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="transaction-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="transaction-list">
              <tr>
                <td colspan="4" style="text-align:center; color: var(--muted); padding: 2rem;">Loading transactions...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p id="user-id-display" style="font-size:.75rem; color:var(--muted); margin-top:.75rem; text-align:right;"></p>
      </section>
    </main>
  </div>

  <!-- Watermark -->
  <div id="watermark">Developed by xGHOST</div>

  <!-- Firebase + App code -->
  <script type="module">
    // --- Firebase SDK (modular v11) ---
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut,
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- Your Firebase Config (from your original app) ---
    const firebaseConfig = {
      apiKey: 'AIzaSyCYS-MvlFVrfcRFL5JFa2dADklwrj1cCbM',
      authDomain: 'xpensedashboard.firebaseapp.com',
      projectId: 'xpensedashboard',
      storageBucket: 'xpensedashboard.firebasestorage.app',
      messagingSenderId: '709303269161',
      appId: '1:709303269161:web:6c6bf60d99a0482de12938',
    };

    // Initialize Firebase (guard against double init)
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Persist login in this browser
    try { await setPersistence(auth, browserLocalPersistence); } catch (e) { console.warn('Could not set persistence:', e?.message || e); }

    // --- State ---
    let userId = null;
    let allTransactions = [];
    let isSignUpMode = false;

    // Prefer real appId from Firebase app when available
    const appId = (app?.options?.appId) || 'default-app-id';

    // --- DOM Refs ---
    const dashboardContainer = document.getElementById('dashboard-container');
    const authContainer = document.getElementById('auth-container');
    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const authEmailInput = document.getElementById('auth-email');
    const authPasswordInput = document.getElementById('auth-password');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const authLink = document.getElementById('auth-link');
    const authLinkText = document.getElementById('auth-link-text');
    const authError = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');

    const form = document.getElementById('add-form');
    const nameInput = document.getElementById('name');
    const amountInput = document.getElementById('amount');
    const typeInput = document.getElementById('type');
    const dateInput = document.getElementById('date');
    const transactionList = document.getElementById('transaction-list');
    const filterNameInput = document.getElementById('filter-name');
    const filterBySelect = document.getElementById('filter-by');
    const sortBySelect = document.getElementById('sort-by');
    const sortOrderBtn = document.getElementById('sort-order-btn');
    const totalSpendEl = document.getElementById('total-spend');
    const totalTransactionsEl = document.getElementById('total-transactions');
    const avgTransactionEl = document.getElementById('avg-transaction');
    const clockEl = document.getElementById('clock');
    const backBtn = document.getElementById('back-btn');
    const historyTitle = document.getElementById('history-title');
    const userIdDisplayEl = document.getElementById('user-id-display');

    // --- UI Helpers ---
    let sortOrder = 'desc';
    let selectedName = null;

    const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount || 0);
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });

    const updateFilterPlaceholder = () => {
      const selectedOption = filterBySelect.options[filterBySelect.selectedIndex];
      filterNameInput.placeholder = `Search by ${selectedOption.text.toLowerCase().replace('filter by ', '')}...`;
    };

    const handleAuthError = (error) => {
      let message = 'An unknown error occurred.';
      switch (error?.code) {
        case 'auth/invalid-email':
          message = 'The email address is not valid.'; break;
        case 'auth/user-disabled':
          message = 'This user has been disabled.'; break;
        case 'auth/user-not-found':
        case 'auth/wrong-password':
          message = 'Invalid email or password.'; break;
        case 'auth/email-already-in-use':
          message = 'This email is already in use.'; break;
        case 'auth/weak-password':
          message = 'Password should be at least 6 characters.'; break;
        case 'auth/popup-closed-by-user':
          message = 'Google sign-in popup closed. Try again.'; break;
        default:
          message = error?.message || message;
      }
      authError.textContent = message;
      console.error('Authentication error:', error);
    };

    const toggleAuthMode = () => {
      isSignUpMode = !isSignUpMode;
      if (isSignUpMode) {
        authTitle.textContent = 'Sign up for a new account';
        authSubmitBtn.textContent = 'Sign Up';
        authLinkText.textContent = 'Already have an account?';
        authLink.textContent = 'Log In';
      } else {
        authTitle.textContent = 'Log in to your Dashboard';
        authSubmitBtn.textContent = 'Log In';
        authLinkText.textContent = "Don't have an account?";
        authLink.textContent = 'Sign Up';
      }
      authError.textContent = '';
    };

    const updateClock = () => {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
      clockEl.textContent = now.toLocaleDateString('en-IN', options);
    };

    const updateSummary = (transactionsToDisplay) => {
      const totalSpend = transactionsToDisplay.reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
      const transactionCount = transactionsToDisplay.length;
      const avgTransaction = transactionCount > 0 ? totalSpend / transactionCount : 0;
      totalSpendEl.textContent = formatCurrency(totalSpend);
      totalTransactionsEl.textContent = transactionCount;
      avgTransactionEl.textContent = formatCurrency(avgTransaction);
    };

    const renderTransactions = () => {
      transactionList.innerHTML = '';
      let transactionsToDisplay = [...allTransactions];

      const filterValue = filterNameInput.value.toLowerCase().trim();
      const filterBy = filterBySelect.value;

      if (selectedName) {
        transactionsToDisplay = transactionsToDisplay.filter((t) => t.name === selectedName);
      }

      if (filterValue) {
        transactionsToDisplay = transactionsToDisplay.filter((t) => {
          let value;
          if (filterBy === 'amount') value = String(t.amount ?? '');
          else if (filterBy === 'date') value = String(t.date ?? '');
          else value = String(t[filterBy] ?? '').toLowerCase();
          return value.includes(filterValue);
        });
      }

      // Sort
      const sortKey = sortBySelect.value;
      transactionsToDisplay.sort((a, b) => {
        let valA = a[sortKey];
        let valB = b[sortKey];
        if (sortKey === 'amount') { valA = Number(valA) || 0; valB = Number(valB) || 0; }
        if (sortKey === 'date') { valA = new Date(valA || 0).getTime(); valB = new Date(valB || 0).getTime(); }
        if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
        if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
        return 0;
      });

      if (transactionsToDisplay.length === 0) {
        const row = document.createElement('tr');
        row.classList.add('empty-row');
        row.innerHTML = `<td colspan="4">No transactions found.</td>`;
        transactionList.appendChild(row);
      } else {
        for (const t of transactionsToDisplay) {
          const row = document.createElement('tr');
          row.classList.add('new-row');
          row.innerHTML = `
            <td class="clickable-name" data-name="${t.name}" data-label="Name">${t.name}</td>
            <td data-label="Amount">${formatCurrency(Number(t.amount) || 0)}</td>
            <td data-label="Type">${t.type}</td>
            <td data-label="Date">${formatDate(t.date)}</td>
          `;
          transactionList.appendChild(row);
        }
      }

      updateSummary(transactionsToDisplay);
    };

    const listenForTransactions = () => {
      // Per-user subcollection under an app grouping (matches your original structure)
      const colRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
      const qRef = query(colRef, orderBy('createdAt', 'desc'));
      onSnapshot(
        qRef,
        (snapshot) => {
          allTransactions = [];
          snapshot.forEach((doc) => allTransactions.push(doc.data()));
          renderTransactions();
        },
        (error) => {
          console.error('Error fetching documents: ', error);
          transactionList.innerHTML = `<tr><td colspan="4" style="text-align:center; color: var(--muted); padding: 2rem;">Error: Could not load transactions.</td></tr>`;
        }
      );
    };

    const enterDetailsView = (name) => {
      selectedName = name;
      historyTitle.textContent = `History for: ${name}`;
      backBtn.classList.remove('hidden');
      filterNameInput.value = '';
      filterBySelect.value = 'name';
      updateFilterPlaceholder();
      renderTransactions();
    };

    const exitDetailsView = () => {
      selectedName = null;
      historyTitle.textContent = 'History';
      backBtn.classList.add('hidden');
      filterNameInput.value = '';
      filterBySelect.value = 'name';
      updateFilterPlaceholder();
      renderTransactions();
    };

    const handleAddTransaction = async (e) => {
      e.preventDefault();
      if (!userId) { authError.textContent = 'Please log in first.'; return; }

      const amountNum = Number(amountInput.value);
      if (Number.isNaN(amountNum) || amountNum < 0) { authError.textContent = 'Please enter a valid non-negative amount.'; return; }

      const newTransaction = {
        name: nameInput.value.trim(),
        amount: amountNum,
        type: typeInput.value,
        date: dateInput.value,
        createdAt: Date.now(), // client timestamp for sorting
      };

      try {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), newTransaction);
        form.reset();
        dateInput.valueAsDate = new Date();
      } catch (error) {
        console.error('Error adding document: ', error);
        authError.textContent = 'Failed to add transaction. Check console.';
      }
    };

    const toggleSortOrder = () => {
      sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
      sortOrderBtn.textContent = sortOrder === 'desc' ? 'Desc ⬇️' : 'Asc ⬆️';
      renderTransactions();
    };

    const handleAuthForm = async (e) => {
      e.preventDefault();
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value;
      authError.textContent = '';
      try {
        if (isSignUpMode) await createUserWithEmailAndPassword(auth, email, password);
        else await signInWithEmailAndPassword(auth, email, password);
      } catch (error) { handleAuthError(error); }
    };

    const handleGoogleSignIn = async () => {
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); }
      catch (error) { handleAuthError(error); }
    };

    const handleLogout = async () => { try { await signOut(auth); } catch (error) { console.error('Logout failed:', error); } };

    // --- Auth state listener ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        dashboardContainer.style.display = 'flex';
        authContainer.style.display = 'none';
        userIdDisplayEl.textContent = `User ID: ${userId}`;
        listenForTransactions();
      } else {
        userId = null;
        dashboardContainer.style.display = 'none';
        authContainer.style.display = 'grid';
        userIdDisplayEl.textContent = '';
        transactionList.innerHTML = `<tr><td colspan=\"4\" style=\"text-align:center; color: var(--muted); padding: 2rem;\">Sign in to load your transactions.</td></tr>`;
      }
    });

    // --- Event Listeners ---
    authForm.addEventListener('submit', handleAuthForm);
    authLink.addEventListener('click', toggleAuthMode);
    googleSignInBtn.addEventListener('click', handleGoogleSignIn);
    logoutBtn.addEventListener('click', handleLogout);

    form.addEventListener('submit', handleAddTransaction);
    filterNameInput.addEventListener('input', renderTransactions);
    filterBySelect.addEventListener('change', () => { updateFilterPlaceholder(); renderTransactions(); });
    sortBySelect.addEventListener('change', renderTransactions);
    sortOrderBtn.addEventListener('click', toggleSortOrder);
    backBtn.addEventListener('click', exitDetailsView);
    transactionList.addEventListener('click', (e) => { if (e.target.classList.contains('clickable-name')) enterDetailsView(e.target.dataset.name); });

    // --- Initial Load ---
    dateInput.valueAsDate = new Date();
    updateClock();
    setInterval(updateClock, 1000);
    updateFilterPlaceholder();
  </script>
</body>
</html>
